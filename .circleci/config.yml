version: 2
jobs:
    build:
        docker:
            - image: fpco/stack-build:lts-11.5
        steps:
            - checkout
            - restore_cache:
                keys:
                  - stack-work-v1-{{ checksum "stack.yaml" }}-{{ checksum "package.yaml" }}
                  # If an exact match is unavailable, use the most recent one
                  - stack-work-v1-
                paths:
                    - ~/.stack
            - run: stack install hlint
            - run:
                name: Lint
                command: git ls-files | grep '\.l\?hs$' | xargs stack exec -- hlint "$@"
            - run:
                name: Build
                command: stack build --no-terminal --pedantic --test --no-run-tests
            - run:
                name: Test
                command: stack test --no-terminal
            - save_cache:
                key: stack-work-v1-{{ checksum "stack.yaml" }}-{{ checksum "package.yaml" }}
                paths:
                    - ~/.stack
